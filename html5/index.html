<html>  
 <head>  
 
	<!-- Libraries -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
   	<script src="libraries/kinetic-v3.8.2.js"></script>
	<script type="text/javascript" src="libraries/paper.js"></script>

	<!-- Sprites -->
	<script src="sprites/person.js"></script> 
	<script src="sprites/gauge.js"></script> 
	<script src="sprites/rushee_face.js"></script> 

	<!-- Views -->
   	<script src="views/bids_view.js"></script> 
   	<script src="views/simulation_view.js"></script> 
   	<script src="views/results_view.js"></script> 
   	<script src="views/plan_view.js"></script> 
   	<script src="views/buy_view.js"></script> 
   	<script src="views/menu_view.js"></script> 
	
	<!-- Data -->
	<script src="data/names.js"></script>
	<script src="data/physical_attr.js"></script>
	<script src="data/eventInfos.js"></script>
	<script src="data/quests.js"></script>

	<!-- Scripts -->
   	<script src="board.js"></script>
	<script src="playing_piece.js"></script>
   	<script src="simulation.js"></script>
   	<script src="global.js"></script> 
	<script src="controller.js"></script>
	
   	<script type="text/paperscript" canvas="canvas">
	window.globals = {};

	//Draws house
	var tr = new Point(0, 0);
	var bl = new Point(300, 300);
	var house = new Path.Rectangle(tr, bl);
	house.fillColor = 'yellow';
	
	//Create bounds for person
	var personHeight = game.UNIT*10;
	var size = new Size(game.UNIT*10, game.UNIT*10);
	var otherRect = new Path.Rectangle(tr, size);
	
	//Create person sprite
	
	//personImage.visible = false;
	
	var repClicks = [];
	function createRep(position) {

		var shape = new Path.Circle(position, game.UNIT);
		shape.fillColor = "blue";
		shape.type = "rep";
		var frameCount, age, duration, alive;
		shape.alive = true;
		age = 0;
		duration = 200;

		shape.step = function() {
			age++;
			if (age % 50 == 0) {
				shape.opacity = shape.opacity*0.5;
			}
			
			if (age > duration) {
				shape.alive = false;
				shape.remove();
			}
		}
		
		shape.die = function() {
			shape.alive = false;
			shape.remove();
		}

		shape.bounce = function() {
			position.blink;
		}
		
		shape.clicked = function() {
			shape.fillColor = "red";
			game.frat.rep += 1;
			updateStatsBar();
			shape.die();
		}

		return shape;
		
		

	}

	var create_goer = function(start) {
		
		var shape = new Raster('person');
		shape.fitBounds(otherRect.bounds);
		shape.position = start;
		shape.visible = true;
		
		shape.type = "person";
		var destVect, inHouse, age, dur, minDist, curDest, speed, destNum, dests = [];
		destNum = 0;
		minDist = 5;
		var repCount = 3;
		repDropProb = .80;
		var stayDuration = 500;
		var enterTime;
		var state = "walking";
		
		//This is arbitrary and should depend on something
		var enterProb = 1;
		
		var entryPath = [ start, new Point(house.bounds.bottomCenter.x, shape.position.y),
					house.bounds.bottomCenter,
					house.bounds.center];
					
		var exitPath = [house.bounds.center, house.bounds.bottomCenter, 
					new Point(house.bounds.bottomCenter.x, shape.position.y),
					new Point(house.bounds.left, start.y)];
					
		var passingPath = [start,new Point(house.bounds.bottomCenter.x, shape.position.y), 
						new Point(house.bounds.left, shape.position.y)];

		var initialize = function() {
			speed = 3;
			age = 0;
			dur = 2000;
			shape.alive = true;
			shape.state = 'born';
		}

		var setDestVector = function(destination) {
			destVect = destination - shape.position;
			destVect = destVect.normalize()*speed;
		}
		

		var talkProb = 0.7;
		var keepTalkProb = 0.99;
		var talkCount = 0;
		shape.step = function() {
			age++;
			switch (shape.state) {
				case 'born':
					if (true) {
						shape.state = 'entering';
						moveAlongPath(entryPath);
					} else {
						shape.state = 'passing';
						moveAlongPath(passingPath);
					}
					//shape.position += destVect;
					break;
					
				case 'entering':
					if (!moveAlongPath(entryPath)) {
						enterTime = age;
						shape.state = "inside";
						speed = speed/3;
					}
					break;
					
				case 'inside':
					speed = 1;
					if (nearTarget()) {
						curDest = randomTarget(house);
						setDestVector(curDest);
					}
					if (Math.random() < talkProb) {
						tryTalk();
					}
					shape.position += destVect;
					if (age > enterTime + stayDuration) {
						curDest = 0;
						moveAlongPath(exitPath)
						shape.state = 'leaving';
					}
					break;
				case 'leaving':
					if (!moveAlongPath(exitPath)) {
						shape.die();
					}
					break;
				
				case 'passing':
					if (!moveAlongPath(passingPath)) {
						shape.die();
					}
					break;
					
				case 'talking':
					talk();
					generateRep();
					var ktp = Math.pow(keepTalkProb, talkCount);
					if (Math.random() > ktp) {
						shape.state = "inside";
						talkCount = 0;
						curDest = randomTarget(house);
						setDestVector(curDest);
					}
					break;
			}
		}
		
		function tryTalk() {
			var hitResult = project.hitTest(shape.position, hitOptions);
			
			if (hitResult && hitResult.item && hitResult.item.type == "person" && hitResult.item.state == "inside" || hitResult.item.type == "member") {
				hitResult.item.state = "talking";
				shape.state = "talking";
			}
		}
		
		shape.tryTalk = tryTalk;
		
		var talkFrame = 0;
		function talk() {
			if (talkFrame < 5) {
				shape.rotate(2);
			} else if (talkFrame < 15) {
				shape.rotate(-2);
			} else if (talkFrame < 20) {
				shape.rotate(2);
			} else {
				talkFrame = 0;
				talkCount++;
				return;
			}
			talkFrame++;
			
		}
		
		function moveAlongPath(path) {
			if (!curDest) {
				curDest = path.shift();
				setDestVector(curDest);
			}
			
			if (nearTarget()) {
				if (path.length > 0) {
					curDest = path.shift();
					setDestVector(curDest);
				} else {
					return false;
				}
			}
			
			shape.position += destVect;
			return true;
		}

		shape.die = function() {
			shape.alive = false;
			shape.remove();
			console.log("DEAD!!");
		}

		function nearTarget() {
			return shape.position.getDistance(curDest) < minDist;
		}

		function generateRep() {
			if (Math.random() > repDropProb && repCount > 0) {
				var pos = shape.position - personHeight/2;
				
				repClicks.push(createRep(pos));
				repCount++;
			}
		}


		function randomTarget(rect) {
			return rect.bounds.topLeft + shape.bounds.size/2 + Point.random()*(rect.bounds.size -shape.bounds.size);
		}
		
		shape.randomTarget = randomTarget;
		initialize();
		return shape;
	}
	
	var create_organizer = (function () {
	
		var posCount = 0;
		
		var startingPositions = [
			house.bounds.bottomCenter + new Point(personHeight*-1.5, personHeight*.5), new Point(300, 300)
		];
	
		return function(member) {
			var position = new Point(0, 0);
			var shape = create_goer(position);
			if (posCount < startingPositions.length) {
				shape.position = startingPositions[posCount];
				posCount++;
				
			} else {
				shape.position = shape.randomTarget(house);
			}
			
			
			shape.type = "member";
			shape.member = member;
			shape.clicked = function() {
				if (clickedMember) {
					clickedMember.selected = false;
				}
				clickedMember = shape;
				console.log(shape.member.id);
				shape.selected = true;
				drawFaceCard(member, "#curMember");
			}
			return shape;
			
		}
	
	})();

	var clickedMember;
	var organizers = [];
	var goers = [];
	game.sim.goersCount = 0;
	function onFrame(event) {
		if (!game.sim.stopped) { 
			if (Math.random() > 0.95 && game.sim.goersCount > 0) {
				goers.push(create_goer(new Point(500, 500)));
				game.sim.goersCount--;
			}
			for (var i = 0; i < goers.length; i++) {
				goers[i].step();
				if (!goers[i].alive) {
					goers.splice(i, 1);
				}
			}

			for (var i = 0; i < repClicks.length; i++) {
				repClicks[i].step();
				if (!repClicks[i].alive) {
					repClicks.splice(i, 1);
				}
			}
			if (goers.length  == 0 && game.sim.goersCount <= 0) {
				game.sim.stopped = true;
				results();
			}
		}
	}
	
	game.sim.start = function() {
		
		partyOrgs = game.frat.getPlay().party;
		console.log(partyOrgs);
		for (var i = 0; i < partyOrgs.length; i++) {
			var curId = partyOrgs[i];
			var newOrg = create_organizer(game.frat.getMemberById(curId));
			organizers.push(newOrg);
		}
		
		game.sim.stopped = false;
	}
	
	game.sim.cleanUp = function() {
		for (var i= 0; i < goers.length; i++) {
			goers[i].die();
			
		}
		for (var i = 0; i < organizers.length; i++) {
			organizers[i].remove();
		}
		
		game.sim.goersCount = 0;
		goers = [];
		repClicks = [];
		organizers = [];
		
	}

	var hitOptions = {
	    segments: false,
	    stroke: false,
	    fill: true,
	    tolerance: 5,
		bounds: true
	};

	function onMouseDown(event) {
		var hitResult = project.hitTest(event.point, hitOptions);
		if (hitResult && hitResult.item.hasOwnProperty("clicked")) {
			hitResult.item.clicked();
			
			if (hitResult.item.type != "member") {
				clickedMember = false;
			}
		}
	}
	
	function onMouseDrag(event) {
		if (clickedMember) {
			clickedMember.position = event.point;
		}
	}
	
	function onMouseUp(event) {
	
		if (clickedMember) {
			clickedMember.tryTalk();
		}
		clickedMember = false;
		
	}
	</script>
   	<!-- Models -->
   	<script src="models/House.js"></script> 
   	<script src="models/Sidewalk.js"></script> 
   	<script src="models/personviz.js"></script>
   	<script src="models/frat.js"></script>
   	<script src="models/skills.js"></script>
   	<script src="models/member.js"></script>
	<script src="models/turn.js"></script>
	
	<!-- DEV -->
	<script src="dev.js"></script> 

	<!-- CSS -->
   	<link rel="stylesheet" href="css/reset.css" />
   	<link rel="stylesheet" href="css/style.css" />
   	
</head>  
<body>
<header><h1>Frat House Tycoon</h1></header>
<nav class="main">
	<ul id="controls">
		<li><button id="run">Run</button></li>
		<li><button id="normal">Normal</button></li>
		<li><button id="fast">Fast</button></li>
		<li><button id="skip">Skip</button></li>
	</ul>
	<ul id="stats">
		<li class="rep" title="Reputation"><object data="sprites/rep_icon.svg" type="image/svg+xml"></object><span class="val">0</span></li>
		<li class="money" title="Money"><object data="sprites/money_icon.svg" type="image/svg+xml"></object><span class="val">0</span></li>
		<li class="brothers" title="Brothers"><object data="sprites/brothers_icon.svg" type="image/svg+xml"></object><span class="val">0</span></li>	
	</ul>
	<ul id="screens">
		<li class="board" title="Board"><button><object data="sprites/board_icon.svg" type="image/svg+xml"></object></button></li>
		<li class="rush" title="Rush"><button><object data="sprites/rush_icon.svg" type="image/svg+xml"></object><span class="val">0</span></button></li>
		<li class="build" title="Build"><button><object data="sprites/build_icon.svg" type="image/svg+xml"></object></button></li>
		<li class="buy" title="Shop"><button><object data="sprites/buy_icon.svg" type="image/svg+xml"></object></button></li>
	</ul>	
	<ul id="skills">
		<li class="rush"><h3><object data="sprites/rush_icon.svg" type="image/svg+xml"></object>Rush</h3><div class="bar"><div class="fill"></div></div></li>
		<li class="party"><h3><object data="sprites/party_icon.svg" type="image/svg+xml"></object>Party</h3><div class="bar"><div class="fill"></div></div></li>
		<li class="cs"><h3><object data="sprites/cs_icon.svg" type="image/svg+xml"></object>Comm. Service</h3><div class="bar"><div class="fill"></div></div></li>
		<li class="study"><h3><object data="sprites/study_icon.svg" type="image/svg+xml"></object>Academic</h3><div class="bar"><div class="fill"></div></div></li>
	</ul>
	<ul id="dev">
		<li><button id="addRushees">+R</button></li>
		<li><button id="addBids">+B</button></li>
	</ul>
</nav> 
<nav class="bidMeeting"><p>You have <span class="val">0</span> bids remaining.<button class="continue">Continue</button></p></nav>
	<div id="menu" class="screens">
		<h1>Frat House Tycoon</h1>
		<h2>Build the fraternity of your dreams!</h2>
		<p class="intro">As president of a fraternity, you must manage its reputation, finance, and membership while balancing academics, parties, rush, and philanthropy.</p>
		<p class="challenge">What will your house be known for?</p>
		<div class="options">
			<button class="sandbox">Sandbox</button>
			<button class="quest">Quest</button>
		</div>
		
<!--
		<div class="sandbox">
			<label>Fraternity Name:</label>
			<input class="frat_name" type="text" />
			<button class="start">Begin</button>
		</div>
		
-->
		<div class="quest">
			<p>Choose a house to run.</p>
			<ul class="quests">
			</ul>
			<button class="cancel">Back</button>
		</div>
	</div> 

   <div id="simulation" class="screens">
	   <canvas id="canvas"></canvas>
	   <canvas id="background"></canvas>
	   <div id="curMember" style="float:right"></div>
   </div>
   
	<div id="planScreen" class="screens">
		<div id="board" style="position: absolute;"></div>
		<h3  style="position:absolute; top:95%;">Next Turn: <span id="nextTurn"></span></h3>
	</div>
	
	<div id="results" class="screens">
		<h2 id='currentTurn'></h2>
		<p class="party"><strong>Party: </strong><span class="val"></span></p>
		<p class="cs"><strong>Philanthropy: </strong><span class="val"></span></p>
		<p class="study"><strong>Study: </strong><span class="val"></span></p>
		<p class="rush"><strong>Rush: </strong><span class="val"></span></p>
		<button class="continue">OK</button>
	</div>
	
	<div id="bidScreen" class="screens">
		<h2>Rushees</h2>
		<ul class="rushees"></ul>
	</div>
	
	<div id="buyScreen" class="screens">
		<h2>Buy</h2>
		<ul class="items"></ul>
	</div>
	<img id="person" src="images/person.png" style="display:none"></img>
 </body>  
</html>

