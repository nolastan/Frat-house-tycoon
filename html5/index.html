<html>  
 <head>  
 
	<!-- Libraries -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
   	<script src="http://www.html5canvastutorials.com/libraries/kinetic-v3.8.2.js"></script>
	<script type="text/javascript" src="libraries/paper.js"></script>

	<!-- Sprites -->
	<script src="sprites/person.js"></script> 
	<script src="sprites/gauge.js"></script> 
	<script src="sprites/rushee_face.js"></script> 

	<!-- Views -->
   	<script src="views/bids_view.js"></script> 
   	<script src="views/simulation_view.js"></script> 
   	<script src="views/results_view.js"></script> 
   	<script src="views/plan_view.js"></script> 
	
	<!-- Data -->
	<script src="data/names.js"></script>
	<script src="data/physical_attr.js"></script>
	<script src="data/eventInfos.js"></script>

	<!-- Scripts -->
	<script src="playing_piece.js"></script>
   	<script src="simulation.js"></script>
   	<script src="global.js"></script> 
	<script src="controller.js"></script>
	
   	<script type="text/paperscript" canvas="canvas">
	window.globals = {};

	var tr = new Point(0, 0);
	var bl = new Point(300, 300);
	var rect = new Path.Rectangle(tr, bl);
	var rectBounds = new Rectangle(tr, bl);
	rect.fillColor = 'black';
	var repClicks = [];
	function createRep(position) {

		var shape = new Path.Circle(position, 10);
		shape.fillColor = "blue";
		shape.type = "rep";
		var frameCount, age, duration, alive;
		shape.alive = true;
		age = 0;
		duration = 200;

		shape.step = function() {
			age++;
			if (age > duration) {
				shape.alive = false;
				shape.remove();
			}
		}
		
		shape.die = function() {
			shape.alive = false;
			shape.remove();
		}

		shape.bounce = function() {
			position.blink;
		}
		
		shape.clicked = function() {
			shape.fillColor = "red";
			game.frat.rep += 1;
			updateStatsBar();
			shape.die();
		}

		return shape;
		
		

	}
	window.globals.createRep = createRep;


	var create_goer = function(start) {
		var shape = new Path.Circle(start, 10);
		var destVect, inHouse, age, dur, minDist, curDest, speed, destNum, dests = [];
		destNum = 0;
		minDist = 5;
		shape.fillColor = 'green';
		var repCount = 3;
		repDropProb = .99;
		var stayDuration = 300;
		var enterTime;
		var state = "walking";

		var initialize = function() {
			dests = [ start, new Point(rect.bounds.bottomCenter.x, shape.position.y),
					rect.bounds.bottomCenter,
					rect.bounds.center];

			curDest = dests[0];
			speed = 3;
			setDestVector();
			inHouse = false;
			leaving = false;
			age = 0;
			dur = 2000;
			shape.alive = true;
		}

		var setDestVector = function() {
			destVect = curDest - shape.position;
			destVect = destVect.normalize()*speed;

		}


		shape.step = function() {
			shape.position += destVect;
			if (nearTarget()) {
				getNextDest();
			}
			age++;
			if (age > dur) {
				shape.die();
			}

			if (!leaving && inHouse && Math.random() > repDropProb && repCount > 0) {
				generateRep();
				repCount--;
			}
		}

		shape.die = function() {
			shape.alive = false;
			shape.remove();
		}

		function nearTarget() {
			return shape.position.getDistance(curDest) < minDist;
		}

		function generateRep() {
			repClicks.push(createRep(shape.position));
		}

		var getNextDest = function() {
			if (inHouse) {
				if (age < enterTime + stayDuration) {
					curDest = randomTarget(rect);
				} else {
					leaving = true;
					destNum--;
					if (destNum >= 0) {
						curDest = dests[destNum];
					} else {
						shape.die();
						return;
					}
				}

			} else {
			destNum++;
			enterTime = age;
				if (destNum < dests.length) {

					curDest = dests[destNum];
				} else {
					inHouse = true;
					speed = speed/3;
				}
			}
			setDestVector();
		}

		function randomTarget(rect) {
			return rect.bounds.topLeft + shape.bounds.size/2 + Point.random()*(rect.bounds.size -shape.bounds.size);
		}
		initialize();
		return shape;
	}


	var goers = [create_goer(new Point(600, 500))];
	game.sim.goersCount = 20;
	function onFrame(event) {
		if (!game.sim.stopped) { 
			if (Math.random() > 0.95 && game.sim.goersCount > 0) {
				goers.push(create_goer(new Point(500, 500)));
				game.sim.goersCount--;
			}
			for (var i = 0; i < goers.length; i++) {
				goers[i].step();
				if (!goers[i].alive) {
					goers.splice(i, 1);
				}
			}

			for (var i = 0; i < repClicks.length; i++) {
				repClicks[i].step();
				if (!repClicks[i].alive) {
					repClicks.splice(i, 1);
				}
			}
			if (goers.length  == 0) {
				game.sim.stopped = true;
				results();
			}
		}
	}
	
	game.sim.cleanUp = function() {
		for (var i= 0; i < goers.length; i++) {
			goers[i].remove;
			goers[i].die();
			
		}
		goers = [create_goer(new Point(600, 500))];
		repClicks = [];
		
	}

	var hitOptions = {
	    segments: false,
	    stroke: false,
	    fill: true,
	    tolerance: 5
	};

	function onMouseDown(event) {
		var hitResult = project.hitTest(event.point, hitOptions);
		if (hitResult && hitResult.item.type == "rep") {
			hitResult.item.clicked();
		}
	}
	</script>
	<script type="text/javascript">
	function dragStart(ev) {
    ev.dataTransfer.effectAllowed='move';
    ev.dataTransfer.setData("Text", ev.target.getAttribute('id'));
    ev.dataTransfer.setDragImage(ev.target,0,0);
    return true;
	}

	function dragEnd(ev) {
		ev.dataTransfer.clearData("Text");
		return true
	}


	function dragEnter(ev) {
		var idelt = ev.dataTransfer.getData("Text");
		return true;
	}

	function dragOver(ev) {
		var idelt = ev.dataTransfer.getData("Text");
		var id = ev.target.getAttribute('id');    
		return false;    
	}

	function dragDrop(ev) {
	  console.log('drop');
		var idelt = ev.dataTransfer.getData("Text");
		ev.target.appendChild(document.getElementById(idelt));
		ev.stopPropagation();
		return false; // return false so the event will not be propagated to the browser
	}
	</script>
   	<!-- Models -->
   	<script src="models/House.js"></script> 
   	<script src="models/Sidewalk.js"></script> 
   	<script src="models/personviz.js"></script>
   	<script src="models/frat.js"></script>
   	<script src="models/skills.js"></script>
   	<script src="models/member.js"></script>
	<script src="models/turn.js"></script>
	
	<!-- DEV -->
	<script src="dev.js"></script> 

	<!-- CSS -->
   	<link rel="stylesheet" href="css/reset.css" />
   	<link rel="stylesheet" href="css/style.css" />
   	
</head>  
<body>
<header><h1>Frat House Tycoon</h1></header>
<nav class="main">
	<ul id="controls">
		<li><button id="run">Run</button></li>
		<li><button id="normal">Normal</button></li>
		<li><button id="fast">Fast</button></li>
		<li><button id="skip">Skip</button></li>
	</ul>
	<ul id="stats">
		<li class="rep" title="Reputation"><object data="sprites/rep_icon.svg" type="image/svg+xml"></object><span class="val">0</span></li>
		<li class="money" title="Money"><object data="sprites/money_icon.svg" type="image/svg+xml"></object><span class="val">0</span></li>
		<li class="brothers" title="Brothers"><object data="sprites/brothers_icon.svg" type="image/svg+xml"></object><span class="val">0</span></li>	
	</ul>
	<ul id="screens">
		<li class="board" title="Board"><button><object data="sprites/board_icon.svg" type="image/svg+xml"></object></button></li>
		<li class="rush" title="Rush"><button><object data="sprites/rush_icon.svg" type="image/svg+xml"></object><span class="val">0</span></button></li>
		<li class="build" title="Build"><button><object data="sprites/build_icon.svg" type="image/svg+xml"></object></button></li>
		<li class="buy" title="Shop"><button><object data="sprites/buy_icon.svg" type="image/svg+xml"></object></button></li>
	</ul>	
	<ul id="skills">
		<li class="rush"><h3><object data="sprites/rush_icon.svg" type="image/svg+xml"></object>Rush</h3><div class="bar"><div class="fill"></div></div></li>
		<li class="party"><h3><object data="sprites/party_icon.svg" type="image/svg+xml"></object>Party</h3><div class="bar"><div class="fill"></div></div></li>
		<li class="cs"><h3><object data="sprites/cs_icon.svg" type="image/svg+xml"></object>Comm. Service</h3><div class="bar"><div class="fill"></div></div></li>
		<li class="study"><h3><object data="sprites/study_icon.svg" type="image/svg+xml"></object>Academic</h3><div class="bar"><div class="fill"></div></div></li>
	</ul>
	<ul id="dev">
		<li><button id="addRushees">+R</button></li>
		<li><button id="addBids">+B</button></li>
	</ul>
</nav> 
<nav class="bidMeeting"><p>You have <span class="val">0</span> bids remaining.<button class="continue">Continue</button></p></nav>
 
   <div id="simulation">
	   <canvas id="canvas"></canvas>
	   <canvas id="background"></canvas>
   </div>
   
	<div id="planScreen">
		<ul class="quadrants">
			<ul class="rush"
			    ondragenter="return dragEnter(event)"
				 ondrop="return dragDrop(event)"
				 ondragover="return dragOver(event)">
				<li><object data="sprites/rush_icon.svg" type="image/svg+xml"></object><h3>Rush</h3></li>
			</ul>
			<ul class="party"><li><object data="sprites/party_icon.svg" type="image/svg+xml"></object><h3>Party</h3></li></ul>
			<ul class="cs"><li><object data="sprites/cs_icon.svg" type="image/svg+xml"></object><h3>Community Service</h3></li></ul>
			<ul class="study"><li><object data="sprites/study_icon.svg" type="image/svg+xml"></object><h3>Academic</h3></li></ul>
		</ul>
		<ul class="members"></ul>
	</div>
	
	<div id="results">
		<h2 id='currentTurn'></h2>
		<p class="party"><strong>Party: </strong><span class="val"></span></p>
		<p class="cs"><strong>Philanthropy: </strong><span class="val"></span></p>
		<p class="study"><strong>Study: </strong><span class="val"></span></p>
		<p class="rush"><strong>Rush: </strong><span class="val"></span></p>
		<button class="continue">OK</button>
	</div>
	
	<div id="bidScreen">
		<h2>Rushees</h2>
		<ul class="rushees"></ul>
	</div>
	
 </body>  
</html>

